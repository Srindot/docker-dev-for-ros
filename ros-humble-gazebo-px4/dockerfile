# 1. Base Image
FROM ghcr.io/srindot/ros2-humble-dev:latest

# Label
LABEL handler="Srindot"
LABEL github="https://github.com/Srindot"

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive

# 2. Switch to ROOT for system installs
USER root

# Install Python packages (Includes kconfiglib/jinja2 to fix menuconfig error)
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install --break-system-packages \
    empy==3.3.4 \
    pyros-genmsg \
    setuptools==70.0.0 \
    kconfiglib \
    jinja2 \
    jsonschema \
    future

# 3. Clone PX4 and Run Setup
# Run as ROOT so ubuntu.sh can install apt packages
WORKDIR /home/rosusr
RUN git clone https://github.com/PX4/PX4-Autopilot.git --recursive && \
    cd PX4-Autopilot && \
    bash ./Tools/setup/ubuntu.sh && \
    # Give ownership back to 'rosusr'
    chown -R rosusr:rosusr /home/rosusr/PX4-Autopilot

# 4. Build PX4 SITL
# Switch to USER to build (prevents root-owned build files)
USER rosusr
WORKDIR /home/rosusr/PX4-Autopilot
RUN make px4_sitl

# 5. Micro-XRCE-DDS Agent
# Switch back to ROOT for system-wide install
USER root
WORKDIR /home/rosusr

RUN git clone -b v2.4.2 https://github.com/eProsima/Micro-XRCE-DDS-Agent.git && \
    cd Micro-XRCE-DDS-Agent && \
    # FIX: Changed '2.12.1' to 'v2.12.1' and used regex for safety
    sed -i 's/set(_fastdds_tag .*/set(_fastdds_tag v2.12.1)/' CMakeLists.txt && \
    mkdir build && cd build && \
    cmake .. && \
    make && \
    make install && \
    ldconfig /usr/local/lib/

# 6. QGroundControl & Final Dependencies
# FIX: Used GitHub URL for reliable download
RUN apt-get update && apt-get install -y \
    gstreamer1.0-plugins-bad \
    gstreamer1.0-libav \
    gstreamer1.0-gl \
    libfuse2 \
    libxcb-xinerama0 \
    libxkbcommon-x11-0 \
    libxcb-cursor0 \
    && apt-get remove modemmanager -y || true \
    && wget https://github.com/mavlink/qgroundcontrol/releases/download/v4.4.4/QGroundControl.AppImage -O /usr/local/bin/QGroundControl \
    && chmod +x /usr/local/bin/QGroundControl

# Cleanup
RUN rm -rf /var/lib/apt/lists/*

# 7. Final User Switch
USER rosusr
WORKDIR /home/rosusr